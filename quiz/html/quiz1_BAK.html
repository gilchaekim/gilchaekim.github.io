<!DOCTYPE html>
<html id="pageRoot" lang="ko">

<head>
  <title>ì‹œí¥ì‹œ ìŠ¤ë§ˆíŠ¸ ì‹œì²­</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/common.css">
  <script type="text/javascript" src="/js/index.js"></script>
</head>

<body>
    <div id="wrapper">
        <div class="inner">
            <header id="header">
                <h1>â—‹â—‹ìƒì‹ì´ ìˆëŠ”ë° ì´ê±¸ ëª¨ë¥¸ë‹¤ê³ ?</h1>
            </header>
            <section id="contents">
                <div class="step_wrap">
                    <div class="qu_lists" id="qu_lists">
                        
                    </div>
                    <div class="countdown">
                        <span class="text" id="text"></span>
                    </div>
                </div>
            </section>
            <footer id="footer">
                <p>ì •ë‹µì„ í†¡í†¡ ë‘ ë²ˆ ëˆŒëŸ¬ì£¼ì„¸ìš”!</p>
            </footer>
        </div>
    </div>

    <script>

        window.audioLog = [];  // ìŒì„± ì¬ìƒ ë¡œê·¸ ì €ì¥
        window.recordStartTime = null;  // ë…¹í™” ì‹œì‘ ì‹œê°„

        const urlParams = new URL(location.href).searchParams;

        const name = urlParams.get('json');
        let quJSON
        console.log(name);
        fetch(`/src/python/${name}`)
        .then(res => res.json())
        .then(function (res) {
            quJSON = res;
            const Quiz = new QuizPlay();
            Quiz.init();
        })
        const {
            $, 
            $$,
            addClass, 
            removeClass, 
            on, 
            Transition, 
            css,
            removeAttr,
            append,
        } = GCui.util;
        const COUNTDOWN = 3;
        let stepCount = 0
        
        class QuizPlay {
            constructor() {
                this.index = 0;
                this.wrap = $('#qu_lists');
            }
            init() {
                this.makeExam(quJSON);
                this.steps = $$('.step', this.wrap);
                this.start();
                
            }
            async start() {
                window.quizFinished = false;
                window.recordStartTime = Date.now();  // ë…¹í™” ì‹œì‘ ì‹œê°„ ì €ì¥
                for (let i = 0; i < this.steps.length; i++) {
                    await this.play(this.steps[i], i);
                    console.log(`ì‚¬ì´í´ ${i+1} ë`);
                }
                console.log('ì¬ìƒ ë');
                console.log(window.audioLog);
                window.quizFinished = true;
                // fetch("http://localhost:5000/quiz-finished", { method: "POST" })  // Python ì„œë²„ì— ì•Œë¦¼
                // .then(response => console.log("Quiz finished signal sent"))
                // .catch(error => console.error("Error:", error));
            }
            async play(step, index){
                const that = this;
                const defaultpath = '/src/python/'
                const qAudio = defaultpath+quJSON[index].question.audio;
                const qu1Audio = defaultpath+quJSON[index].qu1.audio;
                const qu2Audio = defaultpath+quJSON[index].qu2.audio;
                const qu3Audio = defaultpath+quJSON[index].qu3.audio;
                const aAudio = defaultpath+quJSON[index].anwer.audio;
                return new Promise(async (resolve) => {


                    addClass(this.steps[that.index], 'active');

                    await that.delay(2000);
                    console.log();
                    console.log("ğŸ•’ ë¬¸ì œ ì½ì–´ì£¼ê¸°");
                    await that.playAudio(qAudio);
                    await that.playAudio(qu1Audio);
                    await that.playAudio(qu2Audio);
                    await that.playAudio(qu3Audio);

                    // 2ì´ˆ ëŒ€ê¸°
                    await that.delay(2000);

                    console.log("ğŸ•’ ì¹´ìš´íŠ¸ë‹¤ìš´");
                    await that.countdown(COUNTDOWN);

                    await that.delay(2000); 
                    
                    // ì •ë‹µ ë³´ê¸°
                    // await that.playAudio(aAudio);
                    await that.viewAnswer(step, aAudio)
                    
                    //2ì´ˆ ëŒ€ê¸°
                    await that.delay(2000);

                    removeClass(this.steps[that.index], 'active');
                    that.index++
                    // ì‚¬ì´í´ ëë
                    resolve();
                });
            }
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            playAudio(src, duration = null) {
                return new Promise(resolve => {
                    let audio = new Audio(src);
                    audio.addEventListener("loadedmetadata", () => {
                        if (duration) {
                            audio.currentTime = audio.duration - duration;    
                        }
                        
                    });

                    // if (duration) {
                    //     audio.currentTime = audio.duration - 3;
                    // }
                    console.log(duration);
                    // audio.muted = true;
                    // audio.volume = 0.2;
                    let startTime = Date.now(); // ì ˆëŒ€ ì‹œê°„ ê¸°ì¤€
                    let relativeStartTime = window.recordStartTime ? (startTime - window.recordStartTime) : 0; // 
                    // ë…¹í™” ê¸°ì¤€ ìƒëŒ€ ì‹œê°„
                    let logEntry = {
                        src: src,
                        start: relativeStartTime,  // ë…¹í™” ì‹œì‘ ê¸°ì¤€ ìƒëŒ€ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
                        end: null,
                        duration: null
                    };
                    window.audioLog.push(logEntry);
                    audio.play();
                    // audio.muted = false;
                    audio.onended = () =>{
                        let endTime = Date.now();
                        logEntry.end = window.recordStartTime ? (endTime - window.recordStartTime) : 0;
                        logEntry.duration = logEntry.end - logEntry.start;

                        console.log(`ğŸµ ${src} | ë…¹í™” ê¸°ì¤€ ì‹œì‘: ${logEntry.start}ms, ì¢…ë£Œ: ${logEntry.end}ms, ì§€ì†ì‹œê°„: ${logEntry.duration}ms`);
                        resolve();
                    }
                });
            }

            async viewAnswer(step, src) {
                const answer = $('.answer', step);
                const activeCls = 'active';
                await this.playAudio("/audio/end.mp3");
                addClass(answer, activeCls);
                await this.playAudio(src);
                setTimeout(() => {
                    removeClass(answer, activeCls);
                }, 1000);

            }

            makeExam(exem) {
                const list = exem;
                let str = ''
                for (let i = 0; i < list.length; i++) {
                    const qu = list[i];
                    str +=`<div class="step">
                        <div class="title qu_tite">${qu.question.text}</div>
                        <div class="qu_list">
                            <ul>
                                <li>
                                    <span class="num">1</span>
                                    <span class="text qu_01">${qu.qu1.text}</span>
                                </li>
                                <li>
                                    <span class="num">2</span>
                                    <span class="text qu_02">${qu.qu2.text}</span>
                                </li>
                                <li>
                                    <span class="num">3</span>
                                    <span class="text qu_03">${qu.qu3.text}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="answer">
                            <p class=" qu_answer">${qu.anwer.text}</p>
                        </div>
                    </div>`;
                }
                str+=`<div class="step">
                        <div class="end_msg">
                            <p>ë‚´ìš©ì´ ë„ìŒë˜ì…¨ë‹¤ë©´ í™”ë©´ì„ í†¡í†¡ ë‘ ë²ˆ ëˆŒëŸ¬ì£¼ì„¸ìš”! ê°ì‚¬í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>`
                append(this.wrap, str)
            }


            countdown(num) {
                return new Promise((resolve, reject) => {
                    const countEl = $('#text');
                    let timer = null;
                    const activeCls = 'active';
                    const clock_src = "/audio/clock1-1.mp3";
                    // const audio = new Audio(clock_src);
                    this.playAudio(clock_src);
                    let text = num;
                    countEl.innerHTML = text;
                    // addClass(countEl, activeCls)
                    // audio.play();
                    count()
                    timer = setInterval(count, 1000);
                    function count(){
                        // delay(100)
                        if (text <= 0) {
                            
                            clearInterval(timer);
                            resolve();
                        }
                        countEl.innerHTML = text;
                        Transition.start(css(countEl, {opacity:'0', transform:'scale(2)' }), {
                            opacity:1,
                            transform:'scale(1)'
                        }, 200).then(()=>{
                            if (text < 0) {
                                setTimeout(() => {
                                    countEl.innerHTML = '';
                                    removeAttr(countEl, 'style');
                                }, 800);
                            }
                        })
                        --text;
                        
                    }
                })
            }

        }
        
        on(document.documentElement, 'click', play)

        async function play(){
            
            return new Promise(async (resolve, reject) => {
                
                
            })
            
        }


    </script>
</body>
</html>